# üîê Refactorizaci√≥n: Control de Roles en Componente Usuarios

## üìã Resumen

Se ha implementado el sistema centralizado de validaci√≥n de roles (Role Helper v2.0.0) en el componente `Usuarios`, reemplazando la l√≥gica manual de verificaci√≥n de roles por el sistema estandarizado del proyecto.

**Fecha:** 2024-01-30
**Componente afectado:** `/src/components/private/components/usuarios/`
**Archivo modificado:** `hooks/useUsuarios.ts`

---

## üéØ Objetivo

**Proteger la gesti√≥n de usuarios** para que **solo SuperAdmin y Admin** puedan:
- ‚úÖ Acceder al m√≥dulo de usuarios
- ‚úÖ Crear nuevos usuarios
- ‚úÖ Editar usuarios existentes
- ‚úÖ Eliminar usuarios

---

## ‚öôÔ∏è Cambios Implementados

### **1. Imports Actualizados**

```typescript
// ANTES (l√≠neas 12-14)
import { showSuccess, showError, showWarning } from '../../../../../helper/notification/notification.helper';
import { logInfo, logError, logAuth } from '../../../../../helper/log/logger.helper';

// DESPU√âS (l√≠neas 12-20)
import { showSuccess, showError, showWarning } from '../../../../../helper/notification/notification.helper';
import { logInfo, logError, logAuth } from '../../../../../helper/log/logger.helper';
import {
  getUserRoles,
  validateExternalRoles,
  canExternalRoleAccess,
  hasExternalRole
} from '../../../../../helper/role/role.helper';
```

**Funciones importadas:**
- `getUserRoles()` - Obtiene roles desde sessionStorage
- `validateExternalRoles()` - Valida que los roles sean v√°lidos
- `canExternalRoleAccess()` - Verifica acceso jer√°rquico
- `hasExternalRole()` - Verifica rol espec√≠fico

---

### **2. Funci√≥n `checkPermissions()` Refactorizada**

#### **ANTES (l√≠neas 60-101):**
```typescript
const checkPermissions = useCallback(() => {
  // Leer datos del sessionStorage con las keys correctas
  const userData = JSON.parse(sessionStorage.getItem('user_data') || '{}');
  const userRoles = JSON.parse(sessionStorage.getItem('roles') || '[]');

  // Determinar permisos basado en roles
  const isSuperAdmin = userRoles.some((role: any) => role.nombre === 'SuperAdmin');
  const isAdmin = userRoles.some((role: any) => role.nombre === 'Administrador');
  const isSuperior = userRoles.some((role: any) => role.nombre === 'Superior');
  const isElemento = userRoles.some((role: any) => role.nombre === 'Elemento');

  setState(prev => ({
    ...prev,
    canCreateUsers: isSuperAdmin || isAdmin,
    canEditUsers: isSuperAdmin || isAdmin,
    canDeleteUsers: isSuperAdmin || isAdmin,
    canViewAllUsers: isSuperAdmin || isAdmin,
    canViewTeamUsers: isSuperior || isElemento
  }));

  // Verificar acceso b√°sico
  if (!isSuperAdmin && !isAdmin && !isSuperior && !isElemento) {
    showWarning('No tienes permisos para acceder a esta secci√≥n', 'Acceso Restringido');
    navigate('/inicio');
    return false;
  }

  return true;
}, [navigate]);
```

**Problemas detectados:**
- ‚ùå Parsing manual de `sessionStorage`
- ‚ùå L√≥gica dispersa de validaci√≥n de roles
- ‚ùå Uso de `any` para tipos
- ‚ùå No valida que los roles sean v√°lidos seg√∫n la configuraci√≥n del sistema

---

#### **DESPU√âS (l√≠neas 66-149):**
```typescript
/**
 * Verifica y establece permisos del usuario actual
 * Usa el sistema centralizado de validaci√≥n de roles (role.helper v2.0.0)
 *
 * @returns true si tiene acceso, false si debe redirigir
 */
const checkPermissions = useCallback(() => {
  // Obtener roles desde sessionStorage usando el helper
  const userRoles = getUserRoles();

  logInfo('UsuariosHook', 'Validando permisos de usuario', {
    rolesCount: userRoles.length
  });

  // Validar que los roles sean v√°lidos seg√∫n la configuraci√≥n del sistema
  const validRoles = validateExternalRoles(userRoles);

  if (validRoles.length === 0) {
    logError(
      'UsuariosHook',
      new Error('Roles inv√°lidos'),
      'Usuario sin roles v√°lidos en el sistema'
    );
    showWarning('No tienes roles v√°lidos para acceder a esta secci√≥n', 'Acceso Restringido');
    navigate('/inicio');
    return false;
  }

  // Verificar roles espec√≠ficos usando el helper centralizado
  const isSuperAdmin = hasExternalRole(validRoles, 'SUPERADMIN');
  const isAdmin = hasExternalRole(validRoles, 'ADMIN');
  const isSuperior = hasExternalRole(validRoles, 'SUPERIOR');
  const isElemento = hasExternalRole(validRoles, 'ELEMENTO');

  // Verificar acceso jer√°rquico (Admin y superiores)
  const canAccessAdminFeatures = canExternalRoleAccess(validRoles, 'ADMIN');

  // Establecer permisos en el estado
  // Solo SuperAdmin y Admin pueden gestionar usuarios
  setState(prev => ({
    ...prev,
    canCreateUsers: canAccessAdminFeatures,  // Admin o SuperAdmin
    canEditUsers: canAccessAdminFeatures,    // Admin o SuperAdmin
    canDeleteUsers: canAccessAdminFeatures,  // Admin o SuperAdmin
    canViewAllUsers: canAccessAdminFeatures, // Admin o SuperAdmin
    canViewTeamUsers: isSuperior || isElemento // Superior/Elemento (funcionalidad futura)
  }));

  logInfo('UsuariosHook', 'Permisos calculados correctamente', {
    validRolesCount: validRoles.length,
    roles: validRoles.map(r => r.nombre),
    isSuperAdmin,
    isAdmin,
    isSuperior,
    isElemento,
    canCreateUsers: canAccessAdminFeatures,
    canEditUsers: canAccessAdminFeatures,
    canDeleteUsers: canAccessAdminFeatures,
    canViewAllUsers: canAccessAdminFeatures
  });

  // Verificar acceso b√°sico a la secci√≥n de usuarios
  // Solo Admin y SuperAdmin pueden acceder
  if (!canAccessAdminFeatures) {
    logAuth('access_denied', false, {
      section: 'usuarios',
      reason: 'Requiere permisos de Administrador',
      userRoles: validRoles.map(r => r.nombre)
    });
    showWarning(
      'Solo Administradores y SuperAdmins pueden acceder a la gesti√≥n de usuarios',
      'Acceso Restringido'
    );
    navigate('/inicio');
    return false;
  }

  logAuth('access_granted', true, {
    section: 'usuarios',
    userRoles: validRoles.map(r => r.nombre)
  });

  return true;
}, [navigate]);
```

**Mejoras implementadas:**
- ‚úÖ Usa `getUserRoles()` para lectura segura de sessionStorage
- ‚úÖ Valida roles con `validateExternalRoles()`
- ‚úÖ TypeScript strict (sin `any`)
- ‚úÖ Logging estructurado detallado
- ‚úÖ Validaci√≥n jer√°rquica con `canExternalRoleAccess()`
- ‚úÖ Mensajes de error espec√≠ficos

---

### **3. Funci√≥n `handleCreateUser()` Mejorada**

#### **ANTES (l√≠neas 214-222):**
```typescript
const handleCreateUser = useCallback(() => {
  if (!state.canCreateUsers) {
    showWarning('No tienes permisos para crear usuarios', 'Acceso Denegado');
    return;
  }

  logInfo('UsuariosHook', 'Navegando a crear usuario');
  navigate('/usuarios/nuevo');
}, [state.canCreateUsers, navigate]);
```

**Problema:** Solo verifica el estado, no valida en tiempo real.

---

#### **DESPU√âS (l√≠neas 262-289):**
```typescript
/**
 * Navega a la p√°gina de creaci√≥n de usuario
 * Requiere: Admin o SuperAdmin
 */
const handleCreateUser = useCallback(() => {
  // Doble validaci√≥n: estado + verificaci√≥n en tiempo real
  const currentRoles = getUserRoles();
  const canCreate = canExternalRoleAccess(currentRoles, 'ADMIN');

  if (!state.canCreateUsers || !canCreate) {
    logAuth('create_user_denied', false, {
      reason: 'Permisos insuficientes',
      statePermission: state.canCreateUsers,
      runtimePermission: canCreate
    });
    showWarning(
      'Solo Administradores y SuperAdmins pueden crear usuarios',
      'Acceso Denegado'
    );
    return;
  }

  logInfo('UsuariosHook', 'Navegando a crear usuario');
  logAuth('create_user_initiated', true, {
    userRoles: currentRoles.map(r => r.nombre)
  });
  navigate('/usuarios/nuevo');
}, [state.canCreateUsers, navigate]);
```

**Mejoras:**
- ‚úÖ **Doble validaci√≥n**: estado + verificaci√≥n en tiempo real
- ‚úÖ Logging de auditor√≠a con `logAuth()`
- ‚úÖ Mensaje espec√≠fico para permisos insuficientes
- ‚úÖ JSDoc descriptivo

---

### **4. Funci√≥n `handleEditUser()` Mejorada**

#### **ANTES (l√≠neas 224-232):**
```typescript
const handleEditUser = useCallback((usuario: IPaginatedUsers) => {
  if (!state.canEditUsers) {
    showWarning('No tienes permisos para editar usuarios', 'Acceso Denegado');
    return;
  }

  logInfo('UsuariosHook', 'Navegando a editar usuario', { userId: usuario.id });
  navigate(`/usuarios/editar/${usuario.id}`);
}, [state.canEditUsers, navigate]);
```

---

#### **DESPU√âS (l√≠neas 291-318):**
```typescript
/**
 * Navega a la p√°gina de edici√≥n de usuario
 * Requiere: Admin o SuperAdmin
 */
const handleEditUser = useCallback((usuario: IPaginatedUsers) => {
  // Doble validaci√≥n: estado + verificaci√≥n en tiempo real
  const currentRoles = getUserRoles();
  const canEdit = canExternalRoleAccess(currentRoles, 'ADMIN');

  if (!state.canEditUsers || !canEdit) {
    logAuth('edit_user_denied', false, {
      userId: usuario.id,
      reason: 'Permisos insuficientes'
    });
    showWarning(
      'Solo Administradores y SuperAdmins pueden editar usuarios',
      'Acceso Denegado'
    );
    return;
  }

  logInfo('UsuariosHook', 'Navegando a editar usuario', { userId: usuario.id });
  logAuth('edit_user_initiated', true, {
    userId: usuario.id,
    userName: `${usuario.nombre} ${usuario.primer_apellido}`
  });
  navigate(`/usuarios/editar/${usuario.id}`);
}, [state.canEditUsers, navigate]);
```

**Mejoras:**
- ‚úÖ Doble validaci√≥n
- ‚úÖ Logging de auditor√≠a detallado
- ‚úÖ Informaci√≥n del usuario en logs

---

### **5. Funci√≥n `handleDeleteUser()` Mejorada**

#### **ANTES (l√≠neas 234-249):**
```typescript
const handleDeleteUser = useCallback((usuario: IPaginatedUsers) => {
  if (!state.canDeleteUsers) {
    showWarning('No tienes permisos para eliminar usuarios', 'Acceso Denegado');
    return;
  }

  // Abrir el modal de confirmaci√≥n
  setState(prev => ({
    ...prev,
    deleteModalOpen: true,
    usuarioToDelete: usuario,
    deleteError: null
  }));

  logInfo('UsuariosHook', 'Modal de eliminaci√≥n abierto', { userId: usuario.id });
}, [state.canDeleteUsers]);
```

---

#### **DESPU√âS (l√≠neas 320-353):**
```typescript
/**
 * Abre el modal de confirmaci√≥n para eliminar usuario
 * Requiere: Admin o SuperAdmin
 */
const handleDeleteUser = useCallback((usuario: IPaginatedUsers) => {
  // Doble validaci√≥n: estado + verificaci√≥n en tiempo real
  const currentRoles = getUserRoles();
  const canDelete = canExternalRoleAccess(currentRoles, 'ADMIN');

  if (!state.canDeleteUsers || !canDelete) {
    logAuth('delete_user_denied', false, {
      userId: usuario.id,
      reason: 'Permisos insuficientes'
    });
    showWarning(
      'Solo Administradores y SuperAdmins pueden eliminar usuarios',
      'Acceso Denegado'
    );
    return;
  }

  // Abrir el modal de confirmaci√≥n
  setState(prev => ({
    ...prev,
    deleteModalOpen: true,
    usuarioToDelete: usuario,
    deleteError: null
  }));

  logInfo('UsuariosHook', 'Modal de eliminaci√≥n abierto', {
    userId: usuario.id,
    userName: `${usuario.nombre} ${usuario.primer_apellido}`
  });
}, [state.canDeleteUsers]);
```

**Mejoras:**
- ‚úÖ Doble validaci√≥n
- ‚úÖ Logging de auditor√≠a
- ‚úÖ Informaci√≥n completa del usuario

---

## üõ°Ô∏è Matriz de Permisos Implementada

| Acci√≥n | SuperAdmin | Admin | Superior | Elemento |
|--------|------------|-------|----------|----------|
| **Acceder al m√≥dulo** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Ver lista de usuarios** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Crear usuario** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Editar usuario** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Eliminar usuario** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Ver bot√≥n "Nuevo Usuario"** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |

---

## üîç Flujo de Validaci√≥n

### **1. Al cargar el componente:**
```
Usuario accede ‚Üí useUsuarios.checkPermissions()
                 ‚Üì
              getUserRoles() (lee sessionStorage)
                 ‚Üì
              validateExternalRoles() (valida contra sistema)
                 ‚Üì
              validRoles.length === 0? ‚Üí Redirige a /inicio
                 ‚Üì
              canExternalRoleAccess(validRoles, 'ADMIN')
                 ‚Üì
              false? ‚Üí Redirige a /inicio
                 ‚Üì
              true ‚Üí Establece permisos en estado
                 ‚Üì
              Renderiza componente
```

### **2. Al hacer clic en "Nuevo Usuario":**
```
Click en bot√≥n ‚Üí handleCreateUser()
                 ‚Üì
              getUserRoles() (lectura en tiempo real)
                 ‚Üì
              canExternalRoleAccess(currentRoles, 'ADMIN')
                 ‚Üì
              false? ‚Üí showWarning() + logAuth('denied')
                 ‚Üì
              true ‚Üí navigate('/usuarios/nuevo') + logAuth('initiated')
```

### **3. Protecci√≥n en UI:**
```
UsuariosFilters.tsx (l√≠nea 155):
{canCreate && (
  <button onClick={onCreate}>
    Nuevo Usuario
  </button>
)}
```
**Si `canCreate === false`, el bot√≥n NO se renderiza.**

---

## üìä Logging de Auditor√≠a

Todas las operaciones ahora generan logs de auditor√≠a:

### **Acceso al m√≥dulo:**
```typescript
// Acceso denegado
logAuth('access_denied', false, {
  section: 'usuarios',
  reason: 'Requiere permisos de Administrador',
  userRoles: ['Superior']
});

// Acceso concedido
logAuth('access_granted', true, {
  section: 'usuarios',
  userRoles: ['Administrador']
});
```

### **Creaci√≥n de usuario:**
```typescript
// Intento denegado
logAuth('create_user_denied', false, {
  reason: 'Permisos insuficientes',
  statePermission: false,
  runtimePermission: false
});

// Creaci√≥n iniciada
logAuth('create_user_initiated', true, {
  userRoles: ['SuperAdmin']
});
```

### **Edici√≥n de usuario:**
```typescript
logAuth('edit_user_initiated', true, {
  userId: '123',
  userName: 'Juan P√©rez'
});
```

### **Eliminaci√≥n de usuario:**
```typescript
logAuth('delete_user_denied', false, {
  userId: '456',
  reason: 'Permisos insuficientes'
});
```

---

## ‚úÖ Verificaciones de Seguridad

### **1. Validaci√≥n Doble (Defense in Depth):**
- ‚úÖ Validaci√≥n en `checkPermissions()` al montar componente
- ‚úÖ Validaci√≥n en tiempo real en cada acci√≥n (crear/editar/eliminar)
- ‚úÖ Control en UI (botones no se renderizan si no hay permiso)

### **2. Validaci√≥n de Roles:**
- ‚úÖ Roles se validan contra `ALLOWED_ROLES` del `.env`
- ‚úÖ Verificaci√≥n de ID + nombre (doble validaci√≥n)
- ‚úÖ Si roles inv√°lidos ‚Üí redirige a `/inicio`

### **3. Jerarqu√≠a Autom√°tica:**
- ‚úÖ `canExternalRoleAccess(roles, 'ADMIN')` ‚Üí true si es Admin o SuperAdmin
- ‚úÖ SuperAdmin hereda permisos de Admin
- ‚úÖ Basado en configuraci√≥n centralizada (`permissions.config.ts`)

### **4. Logging Completo:**
- ‚úÖ Todos los intentos de acceso se registran
- ‚úÖ Intentos denegados incluyen raz√≥n
- ‚úÖ Acciones exitosas incluyen datos del usuario

---

## üß™ Casos de Prueba Recomendados

### **Test 1: Usuario sin roles**
```
Dado: Usuario con roles = []
Cuando: Intenta acceder a /usuarios
Entonces: Redirige a /inicio + warning "No tienes roles v√°lidos"
```

### **Test 2: Usuario Elemento**
```
Dado: Usuario con rol "Elemento"
Cuando: Intenta acceder a /usuarios
Entonces: Redirige a /inicio + warning "Solo Administradores..."
```

### **Test 3: Usuario Superior**
```
Dado: Usuario con rol "Superior"
Cuando: Intenta acceder a /usuarios
Entonces: Redirige a /inicio + warning "Solo Administradores..."
```

### **Test 4: Usuario Admin**
```
Dado: Usuario con rol "Administrador"
Cuando: Accede a /usuarios
Entonces: Muestra lista de usuarios + bot√≥n "Nuevo Usuario"
Cuando: Click en "Nuevo Usuario"
Entonces: Navega a /usuarios/nuevo
```

### **Test 5: Usuario SuperAdmin**
```
Dado: Usuario con rol "SuperAdmin"
Cuando: Accede a /usuarios
Entonces: Muestra lista de usuarios + bot√≥n "Nuevo Usuario"
Cuando: Click en editar usuario
Entonces: Navega a /usuarios/editar/:id
Cuando: Click en eliminar usuario
Entonces: Abre modal de confirmaci√≥n
```

### **Test 6: Roles inv√°lidos**
```
Dado: Usuario con roles = [{ id: 999, nombre: 'RolInvalido' }]
Cuando: Intenta acceder a /usuarios
Entonces: Redirige a /inicio + warning "Roles inv√°lidos"
```

---

## üì¶ Archivos Afectados

### **Modificados:**
- ‚úÖ `/src/components/private/components/usuarios/hooks/useUsuarios.ts`
  - L√≠neas 15-20: Nuevos imports
  - L√≠neas 66-149: `checkPermissions()` refactorizado
  - L√≠neas 262-289: `handleCreateUser()` mejorado
  - L√≠neas 291-318: `handleEditUser()` mejorado
  - L√≠neas 320-353: `handleDeleteUser()` mejorado

### **Sin cambios (ya protegidos):**
- ‚úÖ `/src/components/private/components/usuarios/Usuarios.tsx`
  - Ya usa `state.canCreateUsers` del hook
- ‚úÖ `/src/components/private/components/usuarios/components/UsuariosFilters.tsx`
  - Bot√≥n "Nuevo Usuario" ya est√° protegido con `{canCreate && ...}`

---

## üöÄ Pr√≥ximos Pasos

1. **Probar en desarrollo:**
   ```bash
   npm run dev
   ```

2. **Verificar con diferentes roles:**
   - Login como Elemento ‚Üí debe redirigir
   - Login como Superior ‚Üí debe redirigir
   - Login como Admin ‚Üí debe permitir acceso completo
   - Login como SuperAdmin ‚Üí debe permitir acceso completo

3. **Revisar logs en consola del navegador:**
   - Verificar logs de `UsuariosHook`
   - Verificar logs de `access_granted` / `access_denied`
   - Verificar logs de `create_user_initiated`, `edit_user_initiated`, etc.

4. **Aplicar mismo patr√≥n a otros componentes:**
   - HistorialIPH
   - EstadisticasUsuario
   - PerfilUsuario
   - etc.

---

## üìö Referencias

- **Documentaci√≥n completa:** `/src/helper/role/README.md`
- **Ejemplos de uso:** `/EXAMPLES_ROLE_HELPER.md`
- **Configuraci√≥n de permisos:** `/src/config/permissions.config.ts`
- **Role Helper:** `/src/helper/role/role.helper.ts`

---

## üìù Notas Adicionales

### **¬øPor qu√© doble validaci√≥n?**
La validaci√≥n doble (estado + tiempo real) previene:
- Manipulaci√≥n de estado en DevTools
- Cambios en sessionStorage despu√©s de montar componente
- Race conditions en renderizado

### **¬øPor qu√© usar `canExternalRoleAccess` en lugar de `hasExternalRole`?**
- `hasExternalRole(roles, 'ADMIN')` ‚Üí true solo si tiene "Administrador"
- `canExternalRoleAccess(roles, 'ADMIN')` ‚Üí true si tiene "Administrador" O "SuperAdmin" (jerarqu√≠a)

### **¬øEl sistema es retrocompatible?**
S√≠, el c√≥digo existente sigue funcionando. Los componentes que no han migrado a√∫n pueden usar el patr√≥n antiguo sin problemas.

---

**Autor:** Sistema IPH Frontend
**Versi√≥n:** 2.0.0
**Fecha:** 2024-01-30
